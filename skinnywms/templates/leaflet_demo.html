<html>
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin=""/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.control.min.css" />
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>

  <script
    src="https://code.jquery.com/jquery-1.12.4.js"
    integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU="
    crossorigin="anonymous"></script>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.min.js"></script>
</head>
<body>
  <div id="mapid"></div>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
    }
    #mapid {
      height: 100%;
    }
  </style>
  <script>
      let mymap = L.map('mapid', {
          center: [0, 0],
          zoom: 2,
          crs: L.CRS.EPSG4326,
          timeDimension: true,
          timeDimensionControl: true,
      });
      let background = L.tileLayer.wms('/wms?', {
          layers: 'background',
          format: 'image/png',
          transparent: 'TRUE',
          attribution: '',
          version: '1.3.0'
      }).addTo(mymap);

      fetch('/wms').then(function(response) {
          return response.text();
      }).then(function(text) {
          let layers = {}
          let legends = {}
          let $xml = $($.parseXML(text));
          $xml.find('Layer').each(function() {
              let name = $(this).find('> Name').text();
              let title = $(this).find('> Title').text();
              let legendurl = $(this).find("> Style > LegendUrl > OnlineResource").attr("xlink:href");
              if (name == "background" || name == "")
                  return;

              let wmslayer = L.tileLayer.wms("/wms", {
                  layers: name,
                  format: 'image/png',
                  transparent: true,
                  version: "1.3.0",
              });
              layers[title] = L.timeDimension.layer.wms(wmslayer, {
                  updateTimeDimension: true,
                  updateTimeDimensionMode: "union",
                  requestTimeFromCapabilities: true,
              });

              let legendControl = L.control({
                  position: 'bottomright'
              });
              legendControl.onAdd = function(map) {
                  var div = L.DomUtil.create('div', 'info legend');
                  div.innerHTML += '<img src="' + legendurl + '"/>';
                  return div;
              };
              legends[title] = legendControl;
          });
          let baseMaps = {
              "background": background,
          };
          L.control.layers(baseMaps, layers).addTo(mymap);
          mymap.on('overlayadd', function(eventLayer) {
              legends[eventLayer.name].addTo(this);
          });
          mymap.on('overlayremove', function(eventLayer) {
              this.removeControl(legends[eventLayer.name]);
          });
      });

      let legend = L.control({
          position: 'bottomright'
      });
      mymap.on('overlayadd', function(e) {
          var div = L.DomUtil.create('div', 'info legend');

      });
  </script>
</body>
</html>
